[% META
    title       = 'Kouyou'
    link_name   = ''
%]
<style type="text/css">
    #kouyou { background-color: white; color: black; border: 1px solid black; margin: 8px 0; padding: 8px; }

    .kouyou-label { font-weight: bold; float: left; width: 8em; height: 1.5em; line-height: 1.5em; }
    .kouyou-value { float: left; font-weight: normal; height: 1.5em; line-height: 1.5em; width: 2.5em; }
    .kouyou-control { position: relative; height: 1.5em; background: white; cursor: pointer; margin: 0 0 2em 11em; }
    .kouyou-control:after { display: block; clear: left; content: ''; }

    .kouyou-gradient { float: left; width: 100%; height: 100%; }
    .kouyou-handle { width: 0; height: 1.5em; margin: -2px; padding: 0; border: 2px solid black; position: absolute; opacity: .8; }

</style>

<script type="text/javascript">
    // uh.  I forget what all this dirty-flag crap is for  8)  I guess to not recalculate until it matters but it will matter instantly
    // what kind of idiot wrote all this with no notes or anything
    
    // ookay so
    // I need to set the dirty flag if a rgb value is set, so I know that everything else needs recalculating.
    function v_color() {
        this._cache_hsl();
    }
    v_color.prototype = {
        m_r: 0,
        m_g: 0,
        m_b: 0,
        cache: {hsldirty: true},
        
        dump: function() {
            var str = '';
            str += "r:\t" + this.m_r + "\n";
            str += "g:\t" + this.m_g + "\n";
            str += "b:\t" + this.m_b + "\n";
            str += "\n";
            str += "h:\t" + this.cache.hue + "\n";
            str += "s:\t" + this.cache.saturation + "\n";
            str += "l:\t" + this.cache.lightness + "\n";
            str += "dirty:\t" + this.cache.hsldirty + "\n";
            return str;
        },

        set_rgb:    function(r, g, b) { this.set_red(r); this.set_green(g); this.set_blue(b); },

        set_red:    function(r) { this.m_r = r / 255; this.cache.hsldirty = true; },
        set_green:  function(g) { this.m_g = g / 255; this.cache.hsldirty = true; },
        set_blue:   function(b) { this.m_b = b / 255; this.cache.hsldirty = true; },
        get_red:    function( ) { return this.m_r * 255; },
        get_green:  function( ) { return this.m_g * 255; },
        get_blue:   function( ) { return this.m_b * 255; },

//            // ONE WAY - HSV
//            this.cache.saturation = delta / max;
//            this.cache.value = max;


        set_hue:        function(val) { if (this.cache.hsldirty) this._cache_hsl(); this.set_hsl(val / 360, this.cache.saturation, this.cache.lightness); },
        set_saturation: function(val) { if (this.cache.hsldirty) this._cache_hsl(); this.set_hsl(this.cache.hue, val / 255, this.cache.lightness); },
        set_lightness:  function(val) { if (this.cache.hsldirty) this._cache_hsl(); this.set_hsl(this.cache.hue, this.cache.saturation, val / 255); },
        get_hue:        function(   ) { if (this.cache.hsldirty) this._cache_hsl(); return this.cache.hue * 360; },
        get_saturation: function(   ) { if (this.cache.hsldirty) this._cache_hsl(); return this.cache.saturation * 255; },
        get_lightness:  function(   ) { if (this.cache.hsldirty) this._cache_hsl(); return this.cache.lightness * 255; },

//        set_value:      function(val) { if (this.cache.hsldirty) this._cache_hsl(); this.cache.value = val; this._commit_hsv(); },
        get_value:      function(   ) { return Math.max(Math.max(this.m_r, this.m_g), this.m_b); },

        
        // RGB -> HSL
        _cache_hsl:    function() {
            var min = Math.min(Math.min(this.m_r, this.m_g), this.m_b);
            var max = Math.max(Math.max(this.m_r, this.m_g), this.m_b);
            var delta = max - min;

            this.cache.hsldirty = false;

            // grayscale'd
            if (max == min) {
                this.cache.hue = 0;  // technically undefined; make this distinction later plz
                this.cache.saturation = this.m_r;
                this.cache.value = this.m_g;
                this.cache.lightness = this.m_b;
                return;
            }
            
            // hue
            if (this.m_r == max)        this.cache.hue = (this.m_g - this.m_b) / delta;
            else if (this.m_g == max)   this.cache.hue = 2 + (this.m_b - this.m_r) / delta;
            else                        this.cache.hue = 4 + (this.m_r - this.m_g) / delta;
            this.cache.hue /= 6;
            if (this.cache.hue < 0) this.cache.hue += 1;

            // saturation
            if (max + min < 1)          this.cache.saturation = delta / (max + min);
            else                        this.cache.saturation = delta / (2 - max - min);
                
            // lightness            
            this.cache.lightness = (max + min) / 2;
        },

        // HSV -> RGB
        _commit_hsv:    function() {
            
            
        },

        // HSL -> RGB
        set_hsl:        function(h, s, l) {
            this.cache.hue = h;
            this.cache.saturation = s;
            this.cache.lightness = l;
            
            // fuck floats
            if (s <= 0.001) {
                this.m_r = l;
                this.m_g = l;
                this.m_b = l;
                return;
            }
            
            var temp2;
            if (l < 0.5)
                temp2 = l * (1 + s);
            else
                temp2 = l + s - l*s;

            var temp1 = 2 * l - temp2;
            
            var obj = {
                r: (h + 4/3) % 1,
                g: (h + 3/3) % 1,
                b: (h + 2/3) % 1
            };
            for (color in obj) {
                if (6 * obj[color] < 1)
                    this['m_' + color] = temp1 + (temp2 - temp1) * 6 * obj[color];
                else if (2 * obj[color] < 1)
                    this['m_' + color] = temp2;
                else if (3 * obj[color] < 2)
                    this['m_' + color] = temp1 + (temp2 - temp1) * 6 * (2/3 - obj[color]);
                else
                    this['m_' + color] = temp1;
            }
        }
    }
</script>

<!--<script>
var str = "x";
function test() {}
test.prototype.x = function() { alert("I am in x  :O"); };
var t = new test;
t[str]();
</script>-->

<script type="text/javascript">
    var kouyou;
    var kouyou_color = new v_color;
    var kouyou_controls = {};
    var kouyou_gradients = {};

    var kouyou_sliders = ['red', 'green', 'blue', 'hue', 'saturation', 'lightness', 'value'];
    // var kouyou_ranges = {hue:360, saturation:255, lightness:255, value:255};

    var slider_values = {};

    var drag_target = null;

    function kouyou_setRGB(r, g, b) {
        kouyou_color.set_rgb(r, g, b);
        //kouyou_repaint();
    }

    function kouyou_load() {
        window.addEventListener('mousemove', do_drag, false);
        window.addEventListener('mouseup', stop_drag, false);
        window.addEventListener('blur', stop_drag, false);

        kouyou = document.getElementById('kouyou');
        for (var s = 0; s < kouyou_sliders.length; s++) {
            var slider = kouyou_sliders[s];
            kouyou_controls[slider] = {};
            slider_values[slider] = 0;

            var label = document.createElement('div');
            label.id = 'kouyou-label-' + slider;
            label.className = 'kouyou-label';
            label.appendChild(document.createTextNode( slider ));
            kouyou.appendChild(label);

            var value = document.createElement('div');
            value.id = 'kouyou-value-' + slider;
            value.className = 'kouyou-value';
            value.appendChild(document.createTextNode( '0' ));
            kouyou_controls[slider].value = value;
            kouyou.appendChild(value);

            var el = document.createElement('div');
            el.id = 'kouyou-control-' + slider;
            el.className = 'kouyou-control';
            kouyou_controls[slider].el = el;
            kouyou.appendChild(el);

            var handle = document.createElement('div');
            handle.className = 'kouyou-handle';
            el.addEventListener('mousedown', start_drag, false);
            el.appendChild(handle);
            kouyou_controls[slider].handle = handle;

            var gradient = document.createElement('img');
            if (slider == 'hue')
                gradient.setAttribute('src', '/images/kouyou/hue.png');
            else
                gradient.setAttribute('src', '/images/kouyou/fadebar.png');
            gradient.className = 'kouyou-gradient';
            gradient.addEventListener('mousedown', function(e) { e.preventDefault() }, false);
            el.appendChild(gradient);

            //kouyou_gradients[slider] = [];
            //for (var i = 0; i < 20; i++) {
            //    kouyou_gradients[slider][i] = document.createElement('div');
            //    kouyou_gradients[slider][i].style.backgroundColor = '#' + hsv2rgb(i / 20, 255, 255);
            //    kouyou_gradients[slider][i].className = 'kouyou-gradient';
            //    el.appendChild(kouyou_gradients.hue[i]);
            //}
        }
        
        // create function to set the color to something arbitrary whatever
    }

    function start_drag(e) {
        if (e.button != 0) return;
        //alert(e.target.parentNode.id);
        //if (e.target.className == 'kouyou-handle')
            drag_target = e.target.parentNode.id.substr(15);
        //    drag_target = 'hue';
        //else
        //    drag_target = e.target.id.substr(15);

        move_handle(drag_target, e.clientX);
        var offset = getLeft(e.target.parentNode);
        kouyou_controls[drag_target].dragpos = e.clientX - offset;
    }

    function do_drag(e) {
        if (drag_target == null) return;
        move_handle(drag_target, e.clientX);
    }

    function stop_drag(e) {
        drag_target = null;
    }

    function move_handle(slider, x) {
        var offset = getLeft(kouyou_controls[slider].el);
        var new_position = x - offset;
        if (new_position < 0) new_position = 0;
        if (new_position > kouyou_controls[slider].el.offsetWidth) new_position = kouyou_controls[slider].el.offsetWidth;
        kouyou_controls[slider].handle.style.left = new_position + "px";

        var new_value = parseInt(new_position / kouyou_controls[slider].el.offsetWidth * (slider == 'hue' ? 360 : 255));
        slider_values[slider] = new_value;
        kouyou_controls[slider].value.innerHTML = new_value;
        
        var str = "BEFORE:\n";
        str += kouyou_color.dump();
        kouyou_color["set_" + slider](new_value);
        str += "\nAFTER " + slider + ":\n";
        str += kouyou_color.dump();
//        alert(str);
        kouyou_repaint();
    }

    // XXX: fix this to use RGB later
    function kouyou_repaint() {
        document.getElementById('kouyou-color').style.backgroundColor = '#' + tohex(kouyou_color.get_red()) + tohex(kouyou_color.get_green()) + tohex(kouyou_color.get_blue());
        document.getElementById('kouyou-hexcode').innerHTML = '#' + tohex(kouyou_color.get_red()) + tohex(kouyou_color.get_green()) + tohex(kouyou_color.get_blue());
    }


    function getLeft(el) {
        var offset = el.offsetLeft;
        var parent = el.offsetParent;
        while (parent != null) { offset += parent.offsetLeft; parent = parent.offsetParent; }
        return offset;
    }

    // 0 <= hue <= 1
    // 0 <= sat < 256
    // 0 <= val < 256
    function hsv2rgb(h, s, v) {
        if (s <= 0.0) return hexcolor(v, v, v);

        s /= 256;
        v /= 256;

        if (h >= 1.0) { h = 0.0 }
        h *= 6;
        var f = h - Math.floor(h);
        var p = Math.floor(256 * v * (1.0 - s));
        var q = Math.floor(256 * v * (1.0 - (s * f)));
        var t = Math.floor(256 * v * (1.0 - (s * (1.0 - f))));
        v = Math.floor(256 * v);
        if (Math.floor(h) == 0) { return hexcolor(v, t, p) }
        else if (Math.floor(h) == 1) { return hexcolor(q, v, p) }
        else if (Math.floor(h) == 2) { return hexcolor(p, v, t) }
        else if (Math.floor(h) == 3) { return hexcolor(p, q, v) }
        else if (Math.floor(h) == 4) { return hexcolor(t, p, v) }
        else if (Math.floor(h) == 5) { return hexcolor(v, p, q) }
        else { throw "wtf" }
    }

    var hex_digits = "0123456789abcdef";
    function hexcolor(r, g, b) { return tohex(r) + tohex(g) + tohex(b); }
    // thx, about.com
    function tohex(d) {
        var h = hex_digits.substr(d&15, 1);
        while (d > 15) { d >>= 4; h = hex_digits.substr(d&15, 1) + h; }
        if (h.length < 2) { h = "0" + h; }
        return h;
    }

    window.addEventListener('load', kouyou_load, false);
</script>

<p>This only works in Firefox.  FYI.</p>

<div id="kouyou">
<div id="kouyou-color">&nbsp;</div>
<div id="kouyou-hexcode">&nbsp;</div>
</div>